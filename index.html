<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-zh="SkyVault" data-en="SkyVault">SkyVault</title>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --background-color: white;
            --text-color: black;
            --button-hover-bg: #007bff;
            --button-hover-text: #ffffff;
            --button-background: transparent;
            --button-border: #007bff;
            --modal-bg: #fefefe;
            --modal-text: #333;
            --close-btn-color: #aaaaaa;
            --close-btn-hover: #000000;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 1s ease, color 1s ease;
            position: relative;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: center;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: var(--background-color);
            color: var(--text-color);
            border: 2px solid var(--button-border);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background-color 1s ease, color 1s ease;
            background-image: none;
            box-shadow: none;
        }
        button, #generate-btn, #download-btn, #location-btn, input {
            padding: 8px 16px;
            font-size: 14px;
            background-color: var(--button-background);
            color: var(--text-color);
            border: 2px solid var(--button-border);
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background-color 1s ease, color 1s ease;
        }
        button:hover, #generate-btn:hover, #download-btn:hover, #location-btn:hover {
            background-color: var(--button-hover-bg);
            color: var(--button-hover-text);
        }
        #loading, #error {
            display: none;
            margin-top: 15px;
        }
        #error {
            color: red;
        }
        #result img {
            max-width: 100%;
            margin-top: 15px;
            image-rendering: auto;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            justify-content: center;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            align-items: center;
        }
        #toggle-dark-mode {
            padding: 8px 16px;
            font-size: 14px;
            background-color: var(--button-background);
            color: var(--text-color);
            border: 2px solid var(--button-border);
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background-color 1s ease, color 1s ease;
            position: fixed;
            top: 10px;
            right: 10px;
        }
        #toggle-dark-mode:hover {
            background-color: var(--button-hover-bg);
            color: var(--button-hover-text);
        }
        body.dark-mode {
            --background-color: #1e1e1e;
            --text-color: #ffffff;
            --button-hover-bg: #4ea8de;
            --button-hover-text: #121212;
            --button-border: #ffffff;
            --modal-bg: #2e2e2e;
            --modal-text: #ffffff;
            --close-btn-color: #ffffff;
            --close-btn-hover: #ffffff;
        }
        body.dark-mode #toggle-dark-mode {
            color: var(--text-color);
            border: 2px solid var(--button-border);
        }
        body.dark-mode #toggle-dark-mode:hover {
            background-color: #ffffff;
            color: #000000;
        }
        body.dark-mode button, 
        body.dark-mode #generate-btn, 
        body.dark-mode #download-btn, 
        body.dark-mode #location-btn {
            color: var(--text-color);
            border: 2px solid var(--button-border);
        }
        body.dark-mode .pagination button {
            border: 1px solid #4ea8de;
            color: #4ea8de;
        }
        body.dark-mode .pagination button.active,
        body.dark-mode .pagination button:hover {
            background-color: #4ea8de;
            color: #121212;
        }
        .github-link {
            margin-bottom: 20px;
            text-align: center;
        }
        .github-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }
        .github-link a:hover {
            text-decoration: underline;
        }
        body.dark-mode a,
        body.dark-mode a:hover,
        body.dark-mode a:visited {
            color: #4ea8de;
        }
        body.dark-mode .form-group label,
        body.dark-mode h1,
        body.dark-mode label {
            color: var(--text-color);
        }
        body.dark-mode input,
        body.dark-mode select {
            background-color: #333333;
            color: #ffffff;
            border: 1px solid #555555;
        }
        body.dark-mode input::placeholder {
            color: #aaaaaa;
        }
        body.dark-mode #error {
            color: #ff6b6b;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        .pagination button {
            padding: 6px 12px;
            font-size: 14px;
            border: 1px solid var(--primary-color);
            background-color: var(--button-background);
            color: var(--text-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 1s ease, color 1s ease;
        }
        .pagination button.active,
        .pagination button:hover {
            background-color: var(--primary-color);
            color: #ffffff;
        }
        .selected-bodies-container {
            margin-top: 20px;
            text-align: center;
        }
        .selected-bodies-title {
            font-size: 14px;
            font-weight: normal;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        .selected-bodies {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            background-color: transparent;
            padding: 5px;
            border-radius: 4px;
            justify-content: center;
        }
        .body-item {
            background-color: #dddddd;
            color: #000000;
            padding: 3px 6px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 1s ease, color 1s ease;
        }
        .body-item:hover {
            background-color: #c0c0c0;
        }
        body.dark-mode .selected-bodies {
            background-color: transparent;
        }
        body.dark-mode .body-item {
            background-color: #555555;
            color: #ffffff;
        }
        body.dark-mode .body-item:hover {
            background-color: #777777;
        }
        .checkboxes-title {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        .category-title {
            text-align: center;
            grid-column: 1 / -1;
            font-size: 1.2em;
            margin-top: 15px;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        .flex-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--modal-bg);
            width: 70%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: var(--modal-text);
            transition: background-color 1s ease, color 1s ease;
        }
        body.dark-mode .modal-content {
            background-color: #2e2e2e;
            color: #ffffff;
        }
        .close-btn {
            color: var(--close-btn-color);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: var(--close-btn-hover);
        }
        body.dark-mode .close-btn:hover,
        body.dark-mode .close-btn:focus {
            color: #ffffff;
        }
        .modal-content ol {
            padding-left: 20px;
            text-align: left;
        }
        .modal-content li {
            margin-bottom: 15px;
            line-height: 1.6;
            color: var(--modal-text);
        }
        body.dark-mode .modal-content li {
            color: #ffffff;
        }
        #add-body-form label {
            display: block;
            margin-top: 10px;
            text-align: left;
            color: var(--text-color);
        }
        #add-body-form input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
            background-color: #333333;
            color: #ffffff;
            border: 1px solid #555555;
        }
        #add-body-form button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #add-body-form button:hover {
            background-color: #0056b3;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            button, #generate-btn, #download-btn, #location-btn, input, select {
                width: 100%;
                padding: 12px 20px;
                font-size: 16px;
            }
            .checkbox-group {
                grid-template-columns: repeat(2, 1fr);
            }
            .pagination {
                flex-wrap: wrap;
            }
            .modal-content {
                width: 90%;
                padding: 20px;
            }
        }

        /* 語言選擇模態樣式 */
        .language-modal {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0,0,0,0.7);
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .language-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .language-modal-content {
            background-color: var(--modal-bg);
            width: 300px;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: var(--modal-text);
            transition: background-color 1s ease, color 1s ease;
        }
        .language-modal-content button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            transition: background-color 1s ease, color 1s ease;
        }
        .language-modal-content button:hover {
            background-color: #0056b3;
        }
    </style>
    <meta property="og:title" content="SkyVault" data-zh="SkyVault" data-en="SkyVault">
    <meta property="og:description" content="生成並顯示行星高度變化圖表" data-zh="一個能顯示天體高度變化的網站" data-en="Generate and display planetary altitude variation charts">
    <meta property="og:image" content="https://yourwebsite.com/path/to/your/image.jpg">
    <meta property="og:url" content="https://starview.space">
    <meta property="og:type" content="website">
</head>
<body>
    <div class="language-modal" id="languageModal">
        <div class="language-modal-content">
            <h2 data-zh="選擇語言" data-en="Choose Language">Choose Language</h2>
            <button onclick="selectLanguage('zh')" data-zh="中文" data-en="Chinese">中文</button>
            <button onclick="selectLanguage('en')" data-zh="英文" data-en="English">English</button>
        </div>
    </div>

    <div class="button-group">
        <button id="toggle-dark-mode">切換深色模式</button>
        <button id="open-tutorial-btn" onclick="openTutorial()" data-zh="如何使用" data-en="How to Use">如何使用</button>
        <button id="github-project-btn" onclick="window.open('https://github.com/HeronSky/Saturn_Static', '_blank')" data-zh="GitHub 專案" data-en="GitHub Project">GitHub Project</button>
    </div>

    <div class="container">
        <h1 data-zh="SkyVault天體變化圖表" data-en="SkyVault Celestial Variation Chart">SkyVault天體變化圖表</h1>
        <div class="modal" id="tutorialModal">
            <div class="modal-content" id="tutorialContent">
                <span class="close-btn" onclick="closeTutorial()">&times;</span>
                <div id="tutorial-steps" style="text-align: left;">
                    <div class="tutorial-step" data-step="1">
                        <h2 data-zh="如何使用 - 步驟 1" data-en="How to Use - Step 1">如何使用 - 步驟 1</h2>
                        <p data-zh="選擇一個或多個天體來生成高度變化圖表。" data-en="Select one or more celestial bodies to generate altitude variation charts.">選擇一個或多個天體來生成高度變化圖表。</p>
                    </div>
                    <div class="tutorial-step" data-step="2" style="display:none;">
                        <h2 data-zh="如何使用 - 步驟 2" data-en="How to Use - Step 2">如何使用 - 步驟 2</h2>
                        <p data-zh="輸入觀測時間範圍，以定義觀測周期。" data-en="Enter the observation time range to define the observation period.">輸入觀測時間範圍，以定義觀測周期。</p>
                    </div>
                    <div class="tutorial-step" data-step="3" style="display:none;">
                        <h2 data-zh="如何使用 - 步驟 3" data-en="How to Use - Step 3">如何使用 - 步驟 3</h2>
                        <p data-zh="選擇位置或手動輸入緯度和經度。" data-en="Select a location or manually enter latitude and longitude.">選擇位置或手動輸入緯度和經度。</p>
                    </div>
                    <div class="tutorial-step" data-step="4" style="display:none;">
                        <h2 data-zh="如何使用 - 步驟 4" data-en="How to Use - Step 4">如何使用 - 步驟 4</h2>
                        <p data-zh="點擊「生成圖表」顯示行星高度變化圖表，並可下載。" data-en="Click 'Generate Chart' to display the planetary altitude variation chart and download it.">點擊「生成圖表」顯示行星高度變化圖表，並可下載。</p>
                    </div>
                    <div class="tutorial-step" data-step="5" style="display:none;">
                        <h2 data-zh="如何使用 - 步驟 5" data-en="How to Use - Step 5">如何使用 - 步驟 5</h2>
                        <p data-zh='有問題或是回饋傳送到 <a href="mailto:admin@starview.space">admin@starview.space</a>' data-en='If you have any problems or feedback, send to <a href="mailto:admin@starview.space">admin@starview.space</a>'>
                            如果有任何問題或建議，請發送到 <a href="mailto:admin@starview.space">admin@starview.space</a>
                        </p>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button id="prevStep" onclick="prevTutorialStep()" disabled data-zh="上一頁" data-en="Previous">Previous</button>
                    <button id="nextStep" onclick="nextTutorialStep()" data-zh="下一頁" data-en="Next">Next</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <h2 class="checkboxes-title" data-zh="選擇天體" data-en="Select Celestial Bodies">選擇天體</h2>
            <div class="checkbox-group" id="checkbox-group">
            </div>
            <div class="pagination" id="pagination">
            </div>
        </div>

        <div class="form-group selected-bodies-container">
            <div class="selected-bodies-title" data-zh="已選擇的天體" data-en="Selected Bodies">已選擇的天體</div>
            <div class="selected-bodies" id="selected-bodies">
            </div>
        </div>

        <div class="form-group">
            <label for="hours" data-zh="時間範圍（小時）:" data-en="Time Range (Hours):">時間範圍（小時）:</label>
            <input type="number" id="hours" name="hours" min="1" max="24" value="8" data-zh="時間範圍（小時）" data-en="Time Range (Hours)">
        </div>

        <div class="form-group">
            <label for="start-time" data-zh="開始時間:" data-en="Start Time:">開始時間:</label>
            <input type="datetime-local" id="start-time" name="start-time" required data-zh="開始時間" data-en="Start Time">
        </div>

        <div class="form-group">
            <label for="latitude" data-zh="緯度:" data-en="Latitude:">緯度:</label>
            <input type="number" id="latitude" name="latitude" step="0.0001" required data-zh="緯度" data-en="Latitude">
            
            <label for="longitude" data-zh="經度:" data-en="Longitude:">經度:</label>
            <input type="number" id="longitude" name="longitude" step="0.0001" required data-zh="經度" data-en="Longitude">
            
            <button id="location-btn" onclick="getCurrentLocation()" data-zh="自動獲取位置" data-en="Get Current Location">自動獲取位置</button>
        </div>

        <div class="form-group flex-row">
            <label for="image-format" data-zh="圖片格式：" data-en="Image Format:">圖片格式：</label>
            <select id="image-format" name="image-format">
                <option value="png" data-zh="PNG" data-en="PNG">PNG</option>
                <option value="jpeg" data-zh="JPEG" data-en="JPEG">JPEG</option>
                <option value="svg" data-zh="SVG" data-en="SVG">SVG</option>
            </select>

            <label for="image-quality" data-zh="圖片品質：" data-en="Image Quality:">圖片品質：</label>
            <select id="image-quality" name="image-quality">
                <option value="low" data-zh="低" data-en="Low">低</option>
                <option value="medium" data-zh="中" data-en="Medium" selected>中</option>
                <option value="high" data-zh="高" data-en="High">高</option>
            </select>

            <button id="generate-btn" onclick="generateChart()" data-zh="生成圖表" data-en="Generate Chart">生成圖表</button>
        </div>

        <div id="loading" data-zh="正在生成圖表，請稍候..." data-en="Generating chart, please wait...">正在生成圖表，請稍候...</div>
        <div id="error"></div>
        <div id="result"></div>
        <button id="download-btn" onclick="downloadImage()" style="display: none;" data-zh="下載圖片" data-en="Download Image">下載圖片</button>
    </div>

    <div class="contact-info">
        <h2>Contact Information</h2>
        <p>Email: <a href="mailto:admin@starview.space">admin@starview.space</a></p>
    </div>

    <script>
        let currentLanguage = 'en'; // 預設語言為英文
        let selectedBodiesSet = new Set();
        let currentPage = 1;
        const itemsPerPage = 9;
        let totalPages = 1;
        let allBodies = [];

        // 載入已選取的天體
        function loadSelectedBodies() {
            const savedSelectedBodies = localStorage.getItem('selectedBodies');
            if (savedSelectedBodies) {
                try {
                    const parsed = JSON.parse(savedSelectedBodies);
                    selectedBodiesSet = new Set(parsed);
                } catch (e) {
                    console.error('Error parsing selectedBodies from localStorage:', e);
                }
            }
        }

        async function loadBodies() {
            try {
                loadSelectedBodies(); // 載入已選取的天體
                const response = await fetch('bodies.txt');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const text = await response.text();
                const lines = text.split('\n')
                                  .map(line => line.trim())
                                  .filter(line => line && !line.startsWith('//'));

                let currentCategory = '';
                allBodies = [];
                lines.forEach(line => {
                    if (line.startsWith('Category:')) {
                        currentCategory = line.replace('Category:', '').trim();
                    } else {
                        const parts = line.split(',').map(part => part.trim());
                        if (parts.length < 3) return; 
                        const value = parts[0];
                        const zh = parts[1];
                        const en = parts[2];
                        
                        let bodyObj = { value, zh, en, category: currentCategory };

                        if (parts.length > 4) { 
                            const raStr = parts[3];
                            const decStr = parts[4];
                            const rightAscension = convertRaToDecimal(raStr);
                            const declination = convertDecToDecimal(decStr);
                            if (rightAscension !== null && declination !== null) {
                                bodyObj.rightAscension = rightAscension;
                                bodyObj.declination = declination;
                            }
                        }
                        allBodies.push(bodyObj);
                    }
                });

                totalPages = Math.ceil(allBodies.length / itemsPerPage);
                currentPage = 1;
                renderCheckboxes();
                renderPagination();
                updateSelectedBodiesList();
            } catch (error) {
                console.error('Error loading bodies.txt:', error);
                showError(currentLanguage === 'zh' ? '無法載入天體資料' : 'Unable to load celestial bodies data');
            }
        }

        function convertRaToDecimal(ra) {
            const parts = ra.match(/(\d+)h\s*(\d+)m\s*(\d+(\.\d+)?)s/);
            if (parts) {
                const hours = parseFloat(parts[1]);
                const minutes = parseFloat(parts[2]);
                const seconds = parseFloat(parts[3]);
                return hours + (minutes / 60) + (seconds / 3600);
            }
            return null;
        }

        function convertDecToDecimal(dec) {
            const parts = dec.match(/([+-]?\d+)°\s*(\d+)'?\s*(\d+(\.\d+)?)"?/);
            if (parts) {
                const degrees = parseFloat(parts[1]);
                const minutes = parseFloat(parts[2]);
                const seconds = parseFloat(parts[3]);
                return degrees + (minutes / 60) + (seconds / 3600);
            }
            return null;
        }

        function renderCheckboxes() {
            const checkboxGroup = document.getElementById('checkbox-group');
            checkboxGroup.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const currentBodies = allBodies.slice(start, end);

            let lastCategory = '';

            currentBodies.forEach(body => {
                if (body.category !== lastCategory) {
                    const categoryTitle = document.createElement('div');
                    categoryTitle.className = 'category-title';
                    categoryTitle.textContent = currentLanguage === 'zh' ? body.category : translateCategory(body.category);
                    checkboxGroup.appendChild(categoryTitle);
                    lastCategory = body.category;
                }

                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.justifyContent = 'center';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'body';
                checkbox.value = body.value;
                checkbox.setAttribute('data-zh', body.zh || body.name);
                checkbox.setAttribute('data-en', body.en || body.name);
                if (selectedBodiesSet.has(body.value)) {
                    checkbox.checked = true;
                }

                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedBodiesSet.add(body.value);
                    } else {
                        selectedBodiesSet.delete(body.value);
                    }
                    updateSelectedBodiesList();
                    // 更新 localStorage
                    localStorage.setItem('selectedBodies', JSON.stringify(Array.from(selectedBodiesSet)));
                });

                const span = document.createElement('span');
                span.textContent = currentLanguage === 'zh' ? (body.zh || body.name) : (body.en || body.name);
                span.setAttribute('data-zh', body.zh || body.name);
                span.setAttribute('data-en', body.en || body.name);

                label.appendChild(checkbox);
                label.appendChild(span);
                checkboxGroup.appendChild(label);
            });
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = currentLanguage === 'zh' ? '上一頁' : 'Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderCheckboxes();
                    renderPagination();
                }
            };
            pagination.appendChild(prevButton);

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                pageButton.onclick = () => {
                    currentPage = i;
                    renderCheckboxes();
                    renderPagination();
                };
                pagination.appendChild(pageButton);
            }

            const nextButton = document.createElement('button');
            nextButton.textContent = currentLanguage === 'zh' ? '下一頁' : 'Next';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderCheckboxes();
                    renderPagination();
                }
            };
            pagination.appendChild(nextButton);
        }

        function translateCategory(category) {
            const translations = {
                '行星': 'Planets',
                '星系': 'Galaxies',
                '星雲': 'Nebulas'
            };
            return translations[category] || category;
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function hideError() {
            const errorEl = document.getElementById('error');
            errorEl.style.display = 'none';
        }

        function updateSelectedBodiesList() {
            const container = document.getElementById('selected-bodies');
            container.innerHTML = '';
            selectedBodiesSet.forEach(body => {
                const div = document.createElement('div');
                div.className = 'body-item';
                div.textContent = getPlanetName(body);
                div.onclick = () => {
                    selectedBodiesSet.delete(body);
                    updateSelectedBodiesList();
                    const checkbox = document.querySelector(`input[value="${body}"]`);
                    if (checkbox) checkbox.checked = false;
                    localStorage.setItem('selectedBodies', JSON.stringify(Array.from(selectedBodiesSet)));
                };
                container.appendChild(div);
            });
        }

        function getPlanetName(bodyValue, lang = currentLanguage) {
            const body = allBodies.find(b => b.value === bodyValue);
            if (!body) return bodyValue;
            return lang === 'zh' ? (body.zh || body.name) : (body.en || body.name);
        }

        async function generateChart() {
            const errorEl = document.getElementById('error');
            const resultEl = document.getElementById('result');
            const loadingEl = document.getElementById('loading');
            const downloadBtn = document.getElementById('download-btn');
            errorEl.style.display = 'none';
            resultEl.innerHTML = '';
            loadingEl.style.display = 'block';
            downloadBtn.style.display = 'none';

            const selectedBodies = Array.from(selectedBodiesSet);
            const hours = parseFloat(document.getElementById('hours').value);
            const startTime = document.getElementById('start-time').value;
            const longitude = parseFloat(document.getElementById('longitude').value);
            const latitude = parseFloat(document.getElementById('latitude').value);
            const imageFormat = document.getElementById('image-format').value;
            const imageQualitySelection = document.getElementById('image-quality').value;

            if (selectedBodies.length === 0) {
                loadingEl.style.display = 'none';
                showError(currentLanguage === 'zh' ? '請至少選擇一個天體' : 'Please select at least one celestial body');
                return;
            }

            if (isNaN(latitude) || isNaN(longitude)) {
                loadingEl.style.display = 'none';
                showError(currentLanguage === 'zh' ? '請輸入有效的緯度和經度' : 'Please enter valid latitude and longitude');
                return;
            }

            if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {
                loadingEl.style.display = 'none';
                showError(currentLanguage === 'zh' ? '請輸入有效的緯度（-90 至 90）和經度（-180 至 180）' : 'Please enter valid latitude (-90 to 90) and longitude (-180 to 180)');
                return;
            }

            try {
                const astro = Astronomy;
                const observer = new astro.Observer(latitude, longitude, 0);

                const startDate = new Date(startTime);
                if (isNaN(startDate)) {
                    loadingEl.style.display = 'none';
                    showError(currentLanguage === 'zh' ? '請輸入有效的開始時間' : 'Please enter a valid start time');
                    return;
                }

                const deltaHours = hours;
                const timeArray = [];
                const totalMilliseconds = deltaHours * 60 * 60 * 1000;
                const step = totalMilliseconds / 100; // 每1%時間範圍的間隔

                for (let i = 0; i <= 100; i++) {
                    let dt = new Date(startDate.getTime() + (i * step));
                    timeArray.push(dt);
                }

                const traces = [];

                for (let bodyName of selectedBodies) {
                    const bodyData = allBodies.find(b => b.value === bodyName);
                    if (!bodyData) {
                        showError(currentLanguage === 'zh' ? `無法找到天體：${bodyName}` : `Unable to find celestial body: ${bodyName}`);
                        return;
                    }

                    const altitudes = [];
                    const times = [];
                    for (let dt of timeArray) {
                        let jd = astro.MakeTime(dt);
                        let horizontal;
                        if (astro.Body[bodyName]) {
                            const equCoords = astro.Equator(bodyName, jd, observer, true, true);
                            horizontal = astro.Horizon(jd, observer, equCoords.ra, equCoords.dec, 'normal');
                        } else if (bodyData.rightAscension !== undefined && bodyData.declination !== undefined) {
                            const ra = bodyData.rightAscension;
                            const dec = bodyData.declination;
                            horizontal = astro.Horizon(jd, observer, ra, dec, 'normal');
                        } else {
                            showError(currentLanguage === 'zh' ? `天體資料不完整：${bodyName}` : `Incomplete data for celestial body: ${bodyName}`);
                            return;
                        }

                        if (horizontal) {
                            altitudes.push(horizontal.altitude);
                            times.push(dt);
                        } else {
                            altitudes.push(null);
                            times.push(dt);
                        }
                    }

                    traces.push({
                        x: times,
                        y: altitudes,
                        mode: 'lines',
                        name: getPlanetName(bodyName),
                        line: { shape: 'spline' } // 添加平滑曲線
                    });
                }

                const layout = {
                    showlegend: true,
                    xaxis: {
                        title: currentLanguage === 'zh' ? '當地時間' : 'Local Time',
                        tickformat: '%H:%M',
                        nticks: Math.min(12, deltaHours + 1)
                    },
                    yaxis: {
                        title: currentLanguage === 'zh' ? '高度 (度)' : 'Altitude (degrees)'
                    }
                };

                Plotly.newPlot(resultEl, traces, layout).then(function(gd) {
                    let imageQuality;
                    switch(imageQualitySelection) {
                        case 'low':
                            imageQuality = 0.5;
                            break;
                        case 'medium':
                            imageQuality = 0.75;
                            break;
                        case 'high':
                            imageQuality = 1;
                            break;
                        default:
                            imageQuality = 1;
                    }

                    let toImageOptions = {
                        format: imageFormat,
                        width: 1280,
                        height: 720,
                        scale: imageQuality
                    };

                    Plotly.toImage(gd, toImageOptions).then(function(dataUrl) {
                        Plotly.purge(resultEl);
                        const img = new Image();
                        img.src = dataUrl;
                        img.alt = currentLanguage === 'zh' ? '天體高度變化圖表' : 'Celestial Bodies Altitude Chart';
                        img.style.maxWidth = '100%';
                        resultEl.appendChild(img);

                        loadingEl.style.display = 'none';
                        downloadBtn.style.display = 'block';
                        downloadBtn.onclick = function() {
                            const link = document.createElement('a');
                            link.href = img.src;
                            link.download = 'chart.' + imageFormat;
                            link.click();
                        };
                    }).catch(function(error) {
                        console.error('生成圖像時出錯:', error);
                        loadingEl.style.display = 'none';
                        showError(currentLanguage === 'zh' ? '生成圖像時出錯' : 'Error generating image');
                    });
                }).catch(function(error) {
                    console.error('生成圖表時出錯:', error);
                    loadingEl.style.display = 'none';
                    showError(currentLanguage === 'zh' ? '生成圖表時出錯' : 'Error generating chart');
                });
            } catch (error) {
                console.error('生成圖表時出錯:', error);
                loadingEl.style.display = 'none';
                showError(currentLanguage === 'zh' ? '生成圖表時出錯' : 'Error generating chart');
            }
        }

        function getCurrentLocation() {
            const latInput = document.getElementById('latitude');
            const lonInput = document.getElementById('longitude');
            const errorEl = document.getElementById('error');

            errorEl.style.display = 'none';
            errorEl.textContent = '';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    latInput.value = position.coords.latitude.toFixed(4);
                    lonInput.value = position.coords.longitude.toFixed(4);
                },
                function(error) {
                    let errorMessage = currentLanguage === 'zh' ? '無法獲取位置：' : 'Unable to get location: ';
                    switch(error.code) {
                        case 1: 
                            errorMessage += currentLanguage === 'zh' ? '用戶拒絕定位請求' : 'User denied location request';
                            break;
                        case 2: 
                            errorMessage += currentLanguage === 'zh' ? '位置資訊不可用' : 'Location information unavailable';
                            break;
                        case 3: 
                            errorMessage += currentLanguage === 'zh' ? '定位請求超時' : 'Location request timed out';
                            break;
                        default:
                            errorMessage += currentLanguage === 'zh' ? '未知錯誤' : 'Unknown error';
                    }

                    errorEl.textContent = errorMessage;
                    errorEl.style.display = 'block';
                }
            );
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            if(document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
            updateDarkModeButtonText();
            renderCheckboxes();
            renderPagination();
            updateSelectedBodiesList();
        }

        function updateDarkModeButtonText() {
            const toggleButton = document.getElementById('toggle-dark-mode');
            toggleButton.textContent = document.body.classList.contains('dark-mode') ? 
                (currentLanguage === 'zh' ? '淺色模式' : 'Light Mode') : 
                (currentLanguage === 'zh' ? '深色模式' : 'Dark Mode');
        }

        function downloadImage() {
            const img = document.querySelector('#result img');
            if (img) {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = 'chart.' + img.src.split('.').pop().split('?')[0];
                link.click();
            }
        }

        function openTutorial() {
            const modal = document.getElementById('tutorialModal');
            modal.classList.add('active');
        }

        function closeTutorial() {
            const modal = document.getElementById('tutorialModal');
            modal.classList.remove('active');
            currentStep = 1;
            updateTutorialSteps();
            updateButtons();
        }

        function selectLanguage(lang) {
            currentLanguage = lang;
            const elements = document.querySelectorAll('[data-zh][data-en]');
            elements.forEach(el => {
                if (el.tagName.toLowerCase() === 'input' || el.tagName.toLowerCase() === 'textarea') {
                    el.placeholder = lang === 'zh' ? el.getAttribute('data-zh') : el.getAttribute('data-en');
                } else {
                    el.innerHTML = lang === 'zh' ? el.getAttribute('data-zh') : el.getAttribute('data-en');
                }
            });

            const langModal = document.getElementById('languageModal');
            langModal.classList.remove('active');

            renderCheckboxes();
            renderPagination();
            updateSelectedBodiesList();
            updateTutorialSteps();
            updateButtons();
        }

        function applyColorScheme() {
            const savedTheme = localStorage.getItem('theme');
            if(savedTheme === 'dark'){
                document.body.classList.add('dark-mode');
            } else if(savedTheme === 'light'){
                document.body.classList.remove('dark-mode');
            } else {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            }
            updateDarkModeButtonText();
        }

        window.onload = async function() {
            const languageModal = document.getElementById('languageModal');
            languageModal.classList.add('active');

            await loadBodies();
            applyColorScheme();
            renderCheckboxes();
            renderPagination();
            updateSelectedBodiesList();
            updateTutorialSteps();
            updateButtons();

            const startTimeInput = document.getElementById('start-time');
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            startTimeInput.value = localDateTime;

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (e.matches) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
                updateDarkModeButtonText();
                renderCheckboxes();
                renderPagination();
                updateSelectedBodiesList();
            });

            // Remove 'onclick' attributes and add event listeners

            // Remove 'onclick' from toggle-dark-mode button
            const toggleDarkModeBtn = document.getElementById('toggle-dark-mode');
            toggleDarkModeBtn.removeAttribute('onclick');

            // Ensure event listener is added
            toggleDarkModeBtn.addEventListener('click', toggleDarkMode);

            // Remove 'onclick' from open-tutorial-btn and add event listener
            const openTutorialBtn = document.getElementById('open-tutorial-btn');
            openTutorialBtn.removeAttribute('onclick');
            openTutorialBtn.addEventListener('click', openTutorial);

            // Remove 'onclick' from github-project-btn and add event listener
            const githubProjectBtn = document.getElementById('github-project-btn');
            githubProjectBtn.removeAttribute('onclick');
            githubProjectBtn.addEventListener('click', function() {
                window.open('https://github.com/HeronSky/Saturn_Static', '_blank');
            });

            // Remove 'onclick' from generate-btn and add event listener
            const generateBtn = document.getElementById('generate-btn');
            generateBtn.removeAttribute('onclick');
            generateBtn.addEventListener('click', generateChart);

            // Remove 'onclick' from download-btn and add event listener
            const downloadBtn = document.getElementById('download-btn');
            downloadBtn.removeAttribute('onclick');
            downloadBtn.addEventListener('click', downloadImage);

            // Remove 'onclick' from location-btn and add event listener
            const locationBtnFinal = document.getElementById('location-btn');
            locationBtnFinal.removeAttribute('onclick');
            locationBtnFinal.addEventListener('click', getCurrentLocation);
        };

        let currentStep = 1;

        function nextTutorialStep() {
            const steps = document.querySelectorAll('.tutorial-step');
            if (currentStep < steps.length) {
                steps[currentStep - 1].style.display = 'none';
                currentStep++;
                steps[currentStep - 1].style.display = 'block';
                updateButtons();

                // 檢查是否為最後一步
                if (currentStep === steps.length) {
                    document.getElementById('nextStep').textContent = currentLanguage === 'zh' ? '完成' : 'Finish';
                }
            } else if (currentStep === steps.length) {
                closeTutorial();
                currentStep = 1; // 重置步驟以便下次使用
                updateButtons();
                document.getElementById('nextStep').textContent = currentLanguage === 'zh' ? '下一頁' : 'Next';
            }
        }

        function prevTutorialStep() {
            const steps = document.querySelectorAll('.tutorial-step');
            if (currentStep > 1) {
                steps[currentStep - 1].style.display = 'none';
                currentStep--;
                steps[currentStep - 1].style.display = 'block';
                updateButtons();
            }
        }

        function updateButtons() {
            const steps = document.querySelectorAll('.tutorial-step');
            const prevBtn = document.getElementById('prevStep');
            const nextBtn = document.getElementById('nextStep');
            prevBtn.disabled = currentStep === 1;

            if (currentStep === steps.length) {
                nextBtn.textContent = currentLanguage === 'zh' ? '完成' : 'Finish';
            } else {
                nextBtn.textContent = currentLanguage === 'zh' ? '下一頁' : 'Next';
            }
        }

        function updateTutorialSteps() {
            const steps = document.querySelectorAll('.tutorial-step');
            steps.forEach((step, index) => {
                step.style.display = index === (currentStep - 1) ? 'block' : 'none';
            });

            // 更新按鈕文字
            const nextBtn = document.getElementById('nextStep');
            if (currentStep === steps.length) {
                nextBtn.textContent = currentLanguage === 'zh' ? '完成' : 'Finish';
            } else {
                nextBtn.textContent = currentLanguage === 'zh' ? '下一頁' : 'Next';
            }

            const prevBtn = document.getElementById('prevStep');
            prevBtn.disabled = currentStep === 1;
        }
    </script>
</body>
</html>